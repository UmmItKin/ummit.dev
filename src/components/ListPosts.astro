---
import type { CollectionPosts } from '@/types'

interface Props {
  list: CollectionPosts[]
}

const { list = [] } = Astro.props

function getDate(date: string) {
  return new Date(date).toISOString()
}

function getHref(post: CollectionPosts) {
  if (post.data.redirect) {
    return post.data.redirect
  }
  const basePath = post.collection === 'blog' ? '/posts' : `/${post.collection}`
  return `${basePath}/${post.slug}`
}

function getTarget(post: CollectionPosts) {
  if (post.data.redirect) {
    return '_blank'
  }
  return '_self'
}

function isSameYear(a: Date | string | number, b: Date | string | number) {
  return a && b && getYear(a) === getYear(b)
}

function getYear(date: Date | string | number) {
  return new Date(date).getFullYear()
}
---

<ul class="sm:min-h-38 min-h-28 mb-18">
  {
    !list || list.length === 0 ? (
      <div class="my-12 opacity-50">nothing here yet.</div>
    ) : (
      list.map((post, index) => (
        <li class="mb-8">
          {!isSameYear(post.data.date, list[index - 1]?.data.date) && (
            <div class="select-none relative h-18 pointer-events-none">
              <span class="text-7em color-transparent font-bold text-stroke-2 text-stroke-hex-aaa op-14 absolute top--0.2em">
                {getYear(post.data.date)}
              </span>
            </div>
          )}
          <a
            class="text-lg lh-tight nav-link flex flex-col gap-2"
            aria-label={post.data.title}
            target={getTarget(post)}
            href={getHref(post)}
          >
            <div class="flex flex-col md:flex-row gap-2 md:items-center">
              <div class="flex gap-2 items-center text-wrap">
                <span class="lh-normal">
                  {post.data.draft && <i class="text-base vertical-mid i-ri-draft-line" />}
                  {post.data.title}
                </span>
              </div>
              <div class="opacity-50 text-sm ws-nowrap flex gap-2 items-center">
                {post.data.redirect && <i class="text-base i-ri-external-link-line" />}
                {post.data.video && <i class="text-base i-ri:film-line" />}
                {post.data.date && <time datetime={getDate(post.data.date)}>{post.data.date.split(',')[0]}</time>}
                {post.data.lastmod && <span class="op-70">· Updated: {post.data.lastmod.split(',')[0]}</span>}
                {post.data.duration && <span>· {post.data.duration}</span>}
                {post.data.tag && <span>· {post.data.tag}</span>}
                {post.data.lang?.includes('zh') && <span>· 中文</span>}
              </div>
            </div>
            <div class="opacity-50 text-sm">{post.data.description}</div>
          </a>
        </li>
      ))
    )
  }
</ul>
